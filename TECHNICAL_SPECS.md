# üîß TECHNICAL SPECIFICATIONS - BattleMap

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏–≥—Ä—ã
**BattleMap** - –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–≥—Ä–∞ –≤ Telegram WebApp, –≥–¥–µ –∏–≥—Ä–æ–∫–∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ –º–∏—Ä–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—è —Å–≤–æ–∏ —Å—Ç—Ä–∞–Ω—ã.

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Telegram App                       ‚îÇ
‚îÇ                    (WebView)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                    HTTPS/WSS
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Vercel (Frontend)                   ‚îÇ
‚îÇ                 React + TypeScript                   ‚îÇ
‚îÇ              https://flagbattle-navy.vercel.app      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                  API/WebSocket
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Render.com (Backend)                 ‚îÇ
‚îÇ                   Node.js + Express                  ‚îÇ
‚îÇ           https://flagbattle-kpph.onrender.com       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                  PostgreSQL
                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Supabase                          ‚îÇ
‚îÇ                  Database + Auth                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üó∫Ô∏è –°–∏—Å—Ç–µ–º–∞ –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:
```javascript
const MAP_SPECIFICATIONS = {
  // –†–∞–∑–º–µ—Ä—ã
  fullSize: 16384,        // 16k x 16k –ø–∏–∫—Å–µ–ª–µ–π
  tileSize: 256,          // –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Ç–∞–π–ª–∞
  totalTiles: 64 * 64,    // 4096 —Ç–∞–π–ª–æ–≤
  
  // –£—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (LOD)
  zoomLevels: [
    { level: 0, scale: 1/16, tiles: 4 },    // –í–µ—Å—å –º–∏—Ä –≤ 4 —Ç–∞–π–ª–∞—Ö
    { level: 1, scale: 1/8,  tiles: 16 },   // –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã
    { level: 2, scale: 1/4,  tiles: 64 },   // –†–µ–≥–∏–æ–Ω—ã
    { level: 3, scale: 1/2,  tiles: 256 },  // –°—Ç—Ä–∞–Ω—ã
    { level: 4, scale: 1,    tiles: 1024 }, // –ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
  ],
  
  // –ü–∞–º—è—Ç—å
  pixelSize: 4,           // RGBA
  maxMemory: "50MB",      // –î–ª—è –≤–∏–¥–∏–º—ã—Ö —Ç–∞–π–ª–æ–≤
  cacheSize: "100MB",     // LocalStorage/IndexedDB
}
```

### –¢–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:
```javascript
// –ö–∞–∂–¥—ã–π —Ç–∞–π–ª –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è
interface Tile {
  z: number;  // Zoom level (0-4)
  x: number;  // X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —Ç–∞–π–ª–∞
  y: number;  // Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ —Ç–∞–π–ª–∞
  pixels: Uint8ClampedArray; // 256x256x4 bytes
}

// URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–π–ª–∞
GET /api/tiles/{z}/{x}/{y}
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

1. **Viewport Culling**
   - –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Ç–∞–π–ª—ã
   - –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö —Ç–∞–π–ª–æ–≤
   - –í—ã–≥—Ä—É–∑–∫–∞ –¥–∞–ª—å–Ω–∏—Ö —Ç–∞–π–ª–æ–≤

2. **Progressive Loading**
   - –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∑–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
   - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º —Ç–∞–π–ª–∞–º

3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
   ```javascript
   // –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   Memory Cache (50MB) -> IndexedDB (100MB) -> Server
   ```

4. **WebSocket –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
   ```javascript
   // –ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   {
     type: "pixel_batch",
     updates: [
       { x: 1000, y: 2000, color: "#FF0000" },
       { x: 1001, y: 2000, color: "#FF0000" },
       // ... –¥–æ 100 –ø–∏–∫—Å–µ–ª–µ–π –≤ –±–∞—Ç—á–µ
     ],
     timestamp: 1234567890
   }
   ```

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ Prisma:
```prisma
model User {
  id            String    @id @default(cuid())
  telegramId    String    @unique
  username      String?
  countryId     String?
  energy        Int       @default(100)
  maxEnergy     Int       @default(100)
  level         Int       @default(1)
  experience    Int       @default(0)
  coins         Int       @default(0)
  pixelsPlaced  Int       @default(0)
}

model Country {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  nameRu       String
  color        String
  totalPixels  Int      @default(0)
  controlledPixels Int  @default(0)
}

model Pixel {
  id          String   @id @default(cuid())
  x           Int
  y           Int
  color       String
  countryId   String
  userId      String
  placedAt    DateTime @default(now())
  
  @@unique([x, y])
  @@index([countryId])
}

model Chunk {
  id          String   @id @default(cuid())
  x           Int      // Chunk X (0-63)
  y           Int      // Chunk Y (0-63)
  data        Bytes    // Compressed pixel data
  version     Int      @default(0)
  updatedAt   DateTime @updatedAt
  
  @@unique([x, y])
}
```

## üîå WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª

### –°–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
```typescript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –∫–∞—Ä—Ç—ã
{
  type: "subscribe",
  viewport: {
    x: 1000,
    y: 2000,
    width: 1024,
    height: 768,
    zoom: 2
  }
}

// –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è
{
  type: "place_pixel",
  x: 5000,
  y: 3000,
  color: "#FF0000"
}
```

### –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:
```typescript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π
{
  type: "pixels_update",
  pixels: [
    { x: 5000, y: 3000, color: "#FF0000", userId: "123" }
  ]
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
{
  type: "energy_update",
  current: 95,
  max: 100,
  nextRestore: "2025-01-08T10:00:00Z"
}
```

## üéÆ –ò–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏

### –°–∏—Å—Ç–µ–º–∞ —ç–Ω–µ—Ä–≥–∏–∏:
- –ù–∞—á–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è: 100
- –†–∞—Å—Ö–æ–¥: 1 –∑–∞ –ø–∏–∫—Å–µ–ª—å
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: 1 –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- VIP –±–æ–Ω—É—Å: x2 —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å:
```javascript
// –†–∞—Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
function calculateControl(countryId) {
  const totalPixels = getCountryPixels(countryId);
  const controlledPixels = getControlledPixels(countryId);
  return (controlledPixels / totalPixels) * 100;
}
```

### Fog of War:
- –ù–µ–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏: —Å–µ—Ä—ã–µ
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ: –ø–æ–ª–Ω—ã–π —Ü–≤–µ—Ç —Å—Ç—Ä–∞–Ω—ã

## üöÄ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

### Phase 1: –ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (—Ç–µ–∫—É—â–∞—è)
- ‚úÖ Simple canvas –∫–∞—Ä—Ç–∞
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ –∫–ª–∏–∫–æ–≤
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —ç–Ω–µ—Ä–≥–∏–∏

### Phase 2: –ü–∏–∫—Å–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- ‚è≥ –¢–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
- ‚è≥ LOD –¥–ª—è –∑—É–º–∞
- ‚è≥ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### Phase 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏
- üìã –ê–ª—å—è–Ω—Å—ã –∏ –∫–æ–º–∞–Ω–¥—ã
- üìã –°–æ–±—ã—Ç–∏—è –∏ –±–æ–Ω—É—Å—ã
- üìã –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- üìã –í–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞

### Phase 4: –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- üìã –ß–∞—Ç –∫–æ–º–∞–Ω–¥—ã
- üìã –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç
- üìã –°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π
- üìã –¢—É—Ä–Ω–∏—Ä—ã

## üì± Telegram WebApp –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### Capabilities:
- ‚úÖ Full Canvas API support
- ‚úÖ WebSocket support
- ‚úÖ LocalStorage/IndexedDB
- ‚úÖ Touch events
- ‚úÖ Device orientation

### Limitations:
- iOS Safari: 384MB canvas memory limit
- Initial window size (need expand())
- No background execution
- Limited to 50MB localStorage

### Optimization strategies:
```javascript
// –î–ª—è iOS Safari
if (isIOS()) {
  // –õ–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–∞–Ω–≤–∞—Å–æ–≤
  MAX_CANVAS_COUNT = 5;
  // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
  CLEANUP_INTERVAL = 30000;
}

// –î–ª—è Android
if (isAndroid()) {
  // –ú–æ–∂–µ–º –ø–æ–∑–≤–æ–ª–∏—Ç—å –±–æ–ª—å—à–µ
  MAX_CANVAS_COUNT = 10;
  CLEANUP_INTERVAL = 60000;
}
```

---

*–í–µ—Ä—Å–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏: 1.0.0*
*–î–∞—Ç–∞: –Ø–Ω–≤–∞—Ä—å 2025*